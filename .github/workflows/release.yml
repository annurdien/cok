name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0, v0.2.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
      
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  build-macos:
    name: Build macOS Binaries
    runs-on: macos-15
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4
        
      - name: Update Version Files
        run: |
          # Remove 'v' prefix for version files
          VERSION_NUM=${VERSION#v}
          
          # Update VERSION file
          echo "$VERSION_NUM" > VERSION
          
          # Update CLI version
          sed -i '' "s/version: \"[0-9]\+\.[0-9]\+\.[0-9]\+\"/version: \"$VERSION_NUM\"/" Sources/TunnelClient/CLI/CokCLI.swift
          
          # Commit changes
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add VERSION Sources/TunnelClient/CLI/CokCLI.swift
          git commit -m "Update version to $VERSION" || echo "No changes to commit"
        env:
          VERSION: ${{ inputs.version }}
        
      - name: Select Xcode 26.2
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Build for ${{ matrix.arch }}
        run: |
          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            swift build -c release --product cok --arch arm64
          else
            swift build -c release --product cok --arch x86_64
          fi
          
      - name: Create tarball
        run: |
          mkdir -p release
          cp .build/release/cok release/
          tar -czf cok-${{ matrix.arch }}-apple-darwin.tar.gz -C release cok
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cok-${{ matrix.arch }}-apple-darwin
          path: cok-${{ matrix.arch }}-apple-darwin.tar.gz

  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    container:
      image: swift:6.0-noble
    steps:
      - uses: actions/checkout@v4

      - name: Update Version Files
        run: |
          # Remove 'v' prefix for version files
          VERSION_NUM=${VERSION#v}
          
          # Update VERSION file
          echo "$VERSION_NUM" > VERSION
          
          # Update CLI version
          sed -i "s/version: \"[0-9]\\+\\.[0-9]\\+\\.[0-9]\\+\"/version: \"$VERSION_NUM\"/" Sources/TunnelClient/CLI/CokCLI.swift
        env:
          VERSION: ${{ inputs.version }}

      - name: Build for Linux
        run: |
          swift build -c release --product cok --static-swift-stdlib
          
      - name: Create tarball  
        run: |
          mkdir -p release
          cp .build/release/cok release/
          tar -czf cok-x86_64-unknown-linux-gnu.tar.gz -C release cok
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cok-x86_64-unknown-linux-gnu
          path: cok-x86_64-unknown-linux-gnu.tar.gz

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-macos, build-linux]
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          
      - name: Generate checksums
        run: |
          sha256sum *.tar.gz > checksums.txt
          cat checksums.txt
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            *.tar.gz
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-publish:
    name: Publish Docker Image
    runs-on: ubuntu-latest
    needs: [create-release]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/cok-server:${{ inputs.version }}
            ghcr.io/${{ github.repository_owner }}/cok-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-homebrew-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [create-release]
    steps:
      - name: Calculate SHA256 for arm64
        id: sha_arm64
        run: |
          SHA=$(curl -sL \
            "https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}/cok-arm64-apple-darwin.tar.gz" \
            | sha256sum | cut -d' ' -f1)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Calculate SHA256 for x86_64
        id: sha_x86_64
        run: |
          SHA=$(curl -sL \
            "https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}/cok-x86_64-apple-darwin.tar.gz" \
            | sha256sum | cut -d' ' -f1)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Clone homebrew-tap
        run: |
          git clone \
            "https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/annurdien/homebrew-tap.git" \
            homebrew-tap

      - name: Generate formula
        run: |
          VERSION_NUM="${{ inputs.version }}"
          VERSION_NUM="${VERSION_NUM#v}"  # strip leading 'v'

          cat > homebrew-tap/Formula/cok.rb << EOF
          class Cok < Formula
            desc "Expose your local web server to the internet with a public URL"
            homepage "https://github.com/${{ github.repository }}"
            version "${VERSION_NUM}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}/cok-arm64-apple-darwin.tar.gz"
                sha256 "${{ steps.sha_arm64.outputs.sha }}"
              else
                url "https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}/cok-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.sha_x86_64.outputs.sha }}"
              end
            end

            def install
              bin.install "cok"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/cok --version")
            end
          end
          EOF

          echo "Generated formula:"
          cat homebrew-tap/Formula/cok.rb

      - name: Commit and push formula
        run: |
          cd homebrew-tap
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add Formula/cok.rb
          git diff --cached --quiet && echo "No changes to formula" && exit 0
          git commit -m "cok ${{ inputs.version }}"
          git push