services:
  server:
    build:
      context: .
      target: server
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - COK_HTTP_PORT=8080
      - COK_WS_PORT=8081
      - COK_DOMAIN=${COK_DOMAIN:-localhost}
      - COK_MAX_TUNNELS=${COK_MAX_TUNNELS:-1000}
      - COK_API_KEY_SECRET=${COK_API_KEY_SECRET:-change-me}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - cok-network

  client:
    build:
      context: .
      target: client
    environment:
      - COK_SERVER_URL=ws://server:8081
      - COK_LOCAL_PORT=3000
      - COK_SUBDOMAIN=${COK_SUBDOMAIN:-}
      - COK_API_KEY=${COK_API_KEY:-}
    depends_on:
      server:
        condition: service_healthy
    network_mode: host
    profiles:
      - client

networks:
  cok-network:
    driver: bridge
